#!/bin/bash

if [ "$1" = "help" ]; then
  echo "
Usage:
club <CLUBHOUSE_ID>

EXAMPLE:
club 1234
"
  exit 0
fi

. env.sh

clubhouse_id="$1"
user="$CLUBHOUSE_USER"
token="$CLUBHOUSE_API_TOKEN"

if [ -z "$clubhouse_id" ]; then
  git checkout master
  exit 0
fi

re='^[0-9]+$'
if ! [[ $clubhouse_id =~ $re ]] ; then
   echo "error: Clubhouse ID not a number" >&2
   exit 1
fi

story=`curl --silent -X GET -H "Content-Type: application/json" -L "https://api.clubhouse.io/api/v2/stories/$clubhouse_id?token=$token"`

re=',"name":"([^"]+)"'
if [[ $story =~ $re ]]; then
  name="${BASH_REMATCH[1]}"
else
  echo "Could not extract name, exiting..."
  echo
  echo $story
  exit 2
fi

convert=`echo $name | sed 's/[^a-zA-Z]/-/g'`

existing_branch=`node -e "
  const json = JSON.parse('$story')
  if (json.branches.length > 0) {
    console.log(json.branches[0].name);
  }
"`

if [ -z "$existing_branch" ]; then
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$current_branch" != "master" ]]; then
    echo "Refusing to create new branch from $current_branch. Check out master branch and try again."
    exit 3
  fi

  git checkout master && git checkout -b $user/ch$clubhouse_id/${convert,,} && git push -u

  if [ $? -eq 0 ]; then
    echo Moving story to \"In Progress\"
    curl --silent -X PUT -H "Content-Type: application/json" -d '{ "workflow_state_id": 500000019 }' -L "https://api.clubhouse.io/api/v2/stories/$clubhouse_id?token=$token" > /dev/null
    echo All done.
  else
    echo Something went wrong, not moving Clubhouse issue
  fi
else
  git fetch
  git checkout $existing_branch
fi

#!/bin/bash

if [ "$1" = "help" ]; then
  echo "
Usage:
club <CLUBHOUSE_ID>

EXAMPLE:
club 1234
"
  exit 0
fi

if [[ `git status --porcelain` ]]; then 
  echo "You have unsaved changes. Please commit or stash them before running this command." 
  exit 5
fi

clubhouse_id="$1"
user="$tools_clubhouse_user"
token="$tools_clubhouse_api_token"

if [ -z "$clubhouse_id" ]; then
  git checkout master
  exit 0
fi

re='^[0-9]+$'
if ! [[ $clubhouse_id =~ $re ]] ; then
   echo "error: Clubhouse ID not a number" >&2
   exit 1
fi

story=`curl --silent -X GET -H "Content-Type: application/json" -L "https://api.clubhouse.io/api/v2/stories/$clubhouse_id?token=$token"`

name=`echo $story | jq -r '.name'`
if [ "$name" = 'null' ]; then
  echo "Could not extract name, exiting..."
  echo
  echo $story
  exit 2
fi

convert=`echo $name | sed 's/[^a-zA-Z]/-/g'`

existing_branch=`echo $story | jq -r '.branches[0].name'`

if [ "$existing_branch" = 'null' ]; then
  git checkout master && git pull && git checkout -b $user/ch$clubhouse_id/${convert,,} && git push -u

  if [ $? -eq 0 ]; then
    echo Moving story to \"In Progress\"
    curl --silent -X PUT -H "Content-Type: application/json" -d '{ "workflow_state_id": 500000019 }' -L "https://api.clubhouse.io/api/v2/stories/$clubhouse_id?token=$token" > /dev/null
    echo All done.
  else
    echo Something went wrong, not moving Clubhouse issue
  fi
else
  git fetch
  git checkout $existing_branch
fi
